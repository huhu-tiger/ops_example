# 运行用户：用 root 便于直接写挂载的日志目录，无需 entrypoint 做 chmod（若需更高安全可改为 nobody 并保证 ./logs 可写）
user root;
# 进程 ID 文件路径
pid /var/run/nginx.pid;
# 工作进程数（auto = 按 CPU 核数）
worker_processes auto;
# 单进程最大可打开文件数，影响并发连接上限
worker_rlimit_nofile 65535;

events {
    # 一次接受多个新连接，提高并发
    multi_accept on;
    # 单进程最大连接数
    worker_connections 65535;
}

http {
    # 响应头中隐藏 nginx 版本号，提升安全
    server_tokens off;
    # 长连接超时：客户端 75s，与上游 65s
    keepalive_timeout 75s 65s;
    # 默认字符集
    charset utf-8;
    # 使用内核 sendfile，减少拷贝、提高静态/代理性能
    sendfile on;
    # 配合 sendfile，凑满包再发，减少小包
    tcp_nopush on;
    # 关闭 Nagle，降低延迟，适合交互/流式
    tcp_nodelay on;
    # 允许的请求体大小上限，大模型请求/上下文可能较大
    client_max_body_size 100M;
    # 增大请求体缓冲区大小，避免写入临时文件产生警告
    client_body_buffer_size 10M;

    # OpenResty 镜像内 mime.types 在安装目录下，用绝对路径；官方 nginx 镜像可改为 include mime.types;
    include /usr/local/openresty/nginx/conf/mime.types;
    default_type application/octet-stream;

    # WebSocket 升级头
    map $http_upgrade $connection_upgrade {
        default upgrade;
        "" close;
    }

    # 请求体由 Lua 在 rewrite 阶段读入并写入 $llm_body_log（见 conf.d 中 rewrite_by_lua_block），此处不依赖 map
    # 若未用 OpenResty/Lua，则 log_format 中的 $llm_body_log 会为空，需在 location 里 set $llm_body_log "-"
    # 错误日志级别（warn 起记）
    error_log /var/log/nginx/error.log warn;
    error_log /dev/stderr warn;

    access_log /var/log/nginx/access.log combined;
    access_log /dev/stdout combined;

    # 代理默认请求头：真实 IP、协议、WebSocket 等
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 与上游建连超时
    proxy_connect_timeout 90s;
    # 向上游发送请求超时
    proxy_send_timeout 90s;
    # 从上游读取响应超时
    proxy_read_timeout 120s;
    # 关闭响应缓冲，便于流式输出
    proxy_buffering off;
    # 关闭请求体缓冲，大包/流式上传更快
    proxy_request_buffering off;

    # Docker 内网 DNS，用于解析 upstream 等
    resolver 127.0.0.11 valid=10s;

    include /etc/nginx/conf.d/*.conf;
}
