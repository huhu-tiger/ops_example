# 大模型服务代理：后端 http://61.49.53.5:30002，Bearer Token 认证，路径前缀 /llm/
server {
    # 监听 80，并作为默认 server（未匹配 host 时使用）
    listen 80 default_server;
    # 接受任意 Host，本实例只做代理
    server_name _;

    # 大模型 API 入口：/llm/ 前缀的请求转发到后端
    location /llm/ {
        set $llm_body_log "";
        access_log off;
        rewrite_by_lua_block {
            ngx.req.read_body()
            local b = ngx.req.get_body_data()
            if not b then
                local fname = ngx.req.get_body_file()
                if fname then
                    local f = io.open(fname, "rb")
                    if f then
                        b = f:read("*a")
                        f:close()
                    end
                end
            end
            if b and #b > 0 then
                b = string.sub(b, 1, 2048):gsub("[\r\n]+", " ")
                ngx.ctx.llm_body_log_raw = b
            else
                ngx.ctx.llm_body_log_raw = "-"
            end
        }
        default_type application/json;
        # if ($llm_bearer_valid = 0) {
        #     return 401 '{"error":"Missing or invalid Bearer token"}';
        # }

        proxy_pass http://61.49.53.5:30002/;
        proxy_request_buffering on;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        proxy_connect_timeout 60s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        log_by_lua_block {
            local raw = ngx.ctx.llm_body_log_raw or "-"
            raw = raw:gsub('\\', '\\\\'):gsub('"', '\\"')
            local line = string.format('%s - [%s] "%s" status=%s upstream_status=%s body_sent=%s upstream_time=%ss request_time=%ss auth_ok=%s request_body="%s"\n',
                ngx.var.remote_addr or "-",
                ngx.var.time_local or "-",
                ngx.var.request or "-",
                ngx.var.status or "-",
                ngx.var.upstream_status or "-",
                ngx.var.body_bytes_sent or "0",
                ngx.var.upstream_response_time or "-",
                ngx.var.request_time or "0",
                ngx.var.llm_bearer_valid or "0",
                raw)
            local path = "/var/log/nginx/llm_proxy.log"
            local f = io.open(path, "a")
            if f then
                f:write(line)
                f:close()
            end
            local out = io.stdout
            if out then out:write(line); out:flush() end
        }
    }

    # 兼容 OpenAI 风格路径：/v1/chat/completions 等直接转发到后端（与 /llm/ 同规则、同认证）
    location /v1/ {
        set $llm_body_log "";
        access_log off;
        rewrite_by_lua_block {
            ngx.req.read_body()
            local b = ngx.req.get_body_data()
            if not b then
                local fname = ngx.req.get_body_file()
                if fname then
                    local f = io.open(fname, "rb")
                    if f then
                        b = f:read("*a")
                        f:close()
                    end
                end
            end
            if b and #b > 0 then
                b = string.sub(b, 1, 2048):gsub("[\r\n]+", " ")
                ngx.ctx.llm_body_log_raw = b
            else
                ngx.ctx.llm_body_log_raw = "-"
            end
        }
        default_type application/json;
        # if ($llm_bearer_valid = 0) {
        #     return 401 '{"error":"Missing or invalid Bearer token"}';
        # }

        proxy_pass http://61.49.53.5:30002/v1/;
        proxy_request_buffering on;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        proxy_connect_timeout 60s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        log_by_lua_block {
            local raw = ngx.ctx.llm_body_log_raw or "-"
            raw = raw:gsub('\\', '\\\\'):gsub('"', '\\"')
            local line = string.format('%s - [%s] "%s" status=%s upstream_status=%s body_sent=%s upstream_time=%ss request_time=%ss auth_ok=%s request_body="%s"\n',
                ngx.var.remote_addr or "-",
                ngx.var.time_local or "-",
                ngx.var.request or "-",
                ngx.var.status or "-",
                ngx.var.upstream_status or "-",
                ngx.var.body_bytes_sent or "0",
                ngx.var.upstream_response_time or "-",
                ngx.var.request_time or "0",
                ngx.var.llm_bearer_valid or "0",
                raw)
            local path = "/var/log/nginx/llm_proxy.log"
            local f = io.open(path, "a")
            if f then
                f:write(line)
                f:close()
            end
            local out = io.stdout
            if out then out:write(line); out:flush() end
        }
    }

    # 其余路径返回 404
    location / {
        default_type application/json;
        return 404 '{"error":"Not found. Use /llm/ or /v1/ for LLM API"}';
    }
}
